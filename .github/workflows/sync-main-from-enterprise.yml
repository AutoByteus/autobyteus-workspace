name: Sync Main From Enterprise

on:
  workflow_dispatch:
  schedule:
    - cron: "23 * * * *"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: sync-main-from-enterprise
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Create or reuse PR from enterprise to main
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const base = "main";
            const head = "enterprise";

            const compare = await github.rest.repos.compareCommitsWithBasehead({
              owner,
              repo,
              basehead: `${base}...${head}`,
            });

            if (compare.data.status !== "ahead" || compare.data.ahead_by === 0) {
              core.info(`No commits to sync: ${head} is not ahead of ${base}.`);
              core.setOutput("pull_request_number", "");
              return;
            }

            const existing = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              base,
              head: `${owner}:${head}`,
              per_page: 100,
            });

            let pr = existing.data.find((p) => p.base.ref === base && p.head.ref === head);
            if (!pr) {
              const created = await github.rest.pulls.create({
                owner,
                repo,
                base,
                head,
                title: "chore(sync): keep main aligned with enterprise",
                body: "Automated sync PR to keep `main` tracking `enterprise`.\n\n- Source: `enterprise`\n- Target: `main`",
              });
              pr = created.data;
              core.info(`Created PR #${pr.number}`);
            } else {
              core.info(`Reusing open PR #${pr.number}`);
            }

            core.setOutput("pull_request_number", String(pr.number));

      - name: Enable auto-merge for sync PR
        if: steps.pr.outputs.pull_request_number != ''
        continue-on-error: true
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.pr.outputs.pull_request_number }}
          merge-method: merge
